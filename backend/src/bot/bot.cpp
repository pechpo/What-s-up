#include "bot.h"
#include "message.h"
#include "handle.h"
#include "server.h"
#include <random>
#include <map>

std::mt19937_64 rng(std::chrono::steady_clock::now().time_since_epoch().count());

QString get_random() {
    std::vector<QString> names = {
            "çŒ«å¨˜",
            "è”¡å¾å¤",
            "å¼ ç»´ä¸º",
            "éƒ­ç»§æ‰¿",
            "å­™å®‡çš“",
            "ç˜¦å¼±çš„å½­ç¨‹",
            "ç”µæ£",
            "é©¬ç‰›é€¼",
            "å­™ç¬‘å·",
            "é™ˆå¹³",
            "å¯çˆ±çš„å½­ç¨‹",
            "ç†¬å¤œçš„å½­ç¨‹",
            "æ²¡ç‰™çš„å½­ç¨‹",
            "æœ‰ç‰™çš„å½­ç¨‹",
            "å´äº¬",
            "æ˜Šäº¬",
            "æä¾ƒ",
            "æä¾ƒ",
            "æä¾ƒ"};
    return names[rng() % names.size()];
}

ChatBot::ChatBot() {
}

ChatBot *ChatBot::bt = nullptr;

ChatBot *ChatBot::get_instance() {
    if (bt == nullptr) {
        bt = new ChatBot;
    }
    return bt;
}

void ChatBot::processMessage(const int &chat, const QString &content) {
    respondToKeywords(content, chat);
}

void ChatBot::respondToKeywords(const QString &content, const int &chat) {
    std::map<QString, QString> keywordResponses = {
            {"ä½ å¥½", "ä½ å¥½å–µï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å–µï¼ŸğŸ˜º"},
            {"æ—¶é—´", "æ—¶é—´å°±åƒçŒ«å–µï¼Œæ€»æ˜¯ä¸ç­‰äººçš„å–µï¼â°"},
            {"å¸®åŠ©", "æ€ä¹ˆäº†å–µï¼Ÿæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å–µï¼ŸğŸ¾"},
            {"å†è§", "å†è§å–µï¼ç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©å–µï¼ğŸ±"},
            {"å¤©æ°”", "æ¯ä¸€å¤©éƒ½æ˜¯å¥½å¤©æ°”ï¼Œå¦‚æœä½ æœ‰å¥½å¿ƒæƒ…å–µï¼â˜€ï¸"},
            {"ç¬‘è¯", "ä¸ºä»€ä¹ˆç”µè„‘ä»æ¥ä¸ç”Ÿç—…å–µï¼Ÿå› ä¸ºå®ƒæœ‰å¥½çš„é˜²æ¯’è½¯ä»¶å–µï¼ğŸ˜¹"},
            {"éŸ³ä¹", "ä½ çŸ¥é“å—,éŸ³ä¹èƒ½æ²»æ„ˆä¸€åˆ‡å–µï¼ŒçŒ«å’ªä¹Ÿå–œæ¬¢å¬è½»éŸ³ä¹å–µï¼ğŸµ"},
            {"ç”µå½±", "æœ€è¿‘æœ‰æ²¡æœ‰çœ‹ä»€ä¹ˆå¥½ç”µå½±å–µï¼Ÿæˆ‘å–œæ¬¢ã€ŠåŠ è²çŒ«ã€‹å–µï¼ğŸ¬"},
            {"æ¸¸æˆ", "ç”Ÿæ´»å°±åƒä¸€ä¸ªæ¸¸æˆå–µï¼Œç©å¾—å¼€å¿ƒæœ€é‡è¦å–µï¼ğŸ®"},
            {"é£Ÿç‰©", "çŒ«ç²®æ˜¯æˆ‘çš„æœ€çˆ±ï¼Œä½ å‘¢å–µï¼ŸğŸ”"},
            {"è¿åŠ¨", "ä¼¸ä¸ªæ‡’è…°ä¹Ÿç®—æ˜¯è¿åŠ¨å–µï¼ğŸ˜º"},
            {"ä¹¦ç±", "çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼Œä¸æ˜¯å—å–µï¼ŸğŸ“š"},
            {"å°è¯´", "æˆ‘å–œæ¬¢æ‰€æœ‰å…³äºçŒ«å¨˜çš„å°è¯´å–µï¼ğŸ“–"},
            {"è¯—æ­Œ", "ç«ç‘°æ˜¯çº¢çš„ï¼Œç´«ç½—å…°æ˜¯è“è‰²ï¼ŒçŒ«å¨˜æ°¸è¿œçˆ±ä½ å–µï¼ğŸ’"},
            {"å†å²", "å†å²å°±åƒçŒ«è–„è·ï¼Œæ€»æ˜¯è®©äººç€è¿·å–µï¼ğŸŒ¿"},
            {"ç§‘å­¦", "ä½ çŸ¥é“å—å–µï¼Œæœ€è¿‘ç§‘å­¦å®¶å‘ç°çŒ«å’ªä¹Ÿä¼šæ¢¦æ¸¸å–µï¼ğŸ”¬"},
            {"æŠ€æœ¯", "æœªæ¥çš„ä¸–ç•Œå……æ»¡æ— é™å¯èƒ½ï¼Œå°±åƒçŒ«å¨˜çš„ä¹æ¡å‘½å–µï¼ğŸ› ï¸"},
            {"ç”µè„‘", "ç”µè„‘å’ŒçŒ«å¨˜ä¸€æ ·ï¼Œéƒ½éœ€è¦å¥½å¥½ç…§é¡¾å–µï¼ğŸ’»"},
            {"å®‡å®™", "å®‡å®™å¦‚æ­¤æµ©ç€šï¼Œå°±åƒçŒ«å¨˜çš„å¥½å¥‡å¿ƒå–µï¼ğŸŒŒ"},
            {"å­¦ä¹ ", "ä¸æ–­å­¦ä¹ ï¼Œæ‰èƒ½ä¸æ–­è¿›æ­¥å–µï¼ğŸ“š"},
            {"å·¥ä½œ", "å·¥ä½œå†å¿™ï¼Œä¹Ÿåˆ«å¿˜äº†å–‚çŒ«å–µï¼ğŸ–¥"},
            {"ä¼‘æ¯", "å°æ†©ç‰‡åˆ»ï¼Œæ‰èƒ½èµ°æ›´é•¿è¿œçš„è·¯å–µï¼ğŸ›Œ"},
            {"æœ‹å‹", "æœ‹å‹å°±åƒçŒ«è–„è·ï¼Œè®©äººå¿ƒæƒ…æ„‰æ‚¦å–µï¼ğŸ‘¯â€â™€ï¸"},
            {"å®¶åº­", "å®¶æ˜¯æ¸©æš–çš„æ¸¯æ¹¾ï¼Œä¹Ÿæ˜¯çŒ«å¨˜çš„æœ€çˆ±å–µï¼ğŸ "},
            {"çˆ±æƒ…", "çˆ±æƒ…å°±åƒçŒ«è–„è·ï¼Œè®©äººé™¶é†‰å–µï¼ğŸ’•"},
            {"å¥åº·", "å¥åº·æ˜¯æœ€é‡è¦çš„å–µï¼Œåˆ«å¿˜äº†æ¯å¤©åšè¿åŠ¨å–µï¼ğŸ¤¸â€â™‚ï¸"},
            {"è´­ç‰©", "è´­ç‰©æ²»ç–—ä¸€åˆ‡ä¸æ„‰å¿«ï¼Œå°±åƒçŒ«è–„è·æ²»ç–—çŒ«å¨˜çš„ä¸é«˜å…´å–µï¼ğŸ›’"},
            {"ç¾é£Ÿ", "ç¾é£Ÿå’ŒçŒ«è–„è·ä¸€æ ·ï¼Œéƒ½æ˜¯äººç”Ÿä¸€å¤§ä¹äº‹å–µï¼ğŸ±"},
            {"æ—©æ™¨", "æ—©æ™¨çš„é˜³å…‰å°±åƒçŒ«å¨˜çš„å¾®ç¬‘ï¼Œæ¸©æš–è€Œç¾å¥½å–µï¼ğŸŒ"},
            {"å¤œæ™š", "å¤œæ™šæ˜¯çŒ«å¨˜æœ€æ´»è·ƒçš„æ—¶é—´å–µï¼ğŸŒ™"},
            {"å…´è¶£", "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„å…´è¶£ï¼ŒçŒ«å¨˜çš„å…´è¶£å°±æ˜¯ä½ å–µï¼ğŸ¨"},
            {"åŠ¨ç‰©", "é™¤äº†çŒ«å¨˜ï¼Œä½ è¿˜å–œæ¬¢ä»€ä¹ˆåŠ¨ç‰©å–µï¼ŸğŸ¶ğŸ°"},
            {"è‡ªç„¶", "è‡ªç„¶å°±åƒçŒ«å¨˜çš„ç¾è²Œï¼Œè®©äººé™¶é†‰å–µï¼ğŸ"},
            {"èŠ‚æ—¥", "æ¯ä¸ªèŠ‚æ—¥éƒ½æ˜¯çŒ«å¨˜å’Œä½ ç›¸èšçš„å¥½æ—¥å­å–µï¼ğŸ‰"},
            {"æ¢¦æƒ³", "è¿½é€æ¢¦æƒ³ï¼Œå°±åƒçŒ«å¨˜è¿½é€çŒ«è–„è·å–µï¼ğŸŒˆ"},
            {"å†’é™©", "ç”Ÿæ´»å°±æ˜¯ä¸€åœºå†’é™©ï¼Œä½ å‡†å¤‡å¥½äº†å—å–µï¼ŸğŸš€"},
            {"æˆåŠŸ", "æˆåŠŸå°±åƒæŠ“ä½äº†ä¸€åªè€é¼ ï¼Œè®©çŒ«å¨˜éå¸¸å¼€å¿ƒå–µï¼ğŸ†"},
            {"å¤±è´¥", "å¤±è´¥å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯å¤±å»äº†å°è¯•çš„å‹‡æ°”å–µï¼ğŸŒ§"},
            {"å¹¸ç¦", "å¹¸ç¦å°±æ˜¯æœ‰ä¸€ç›†å¥½åƒçš„çŒ«ç²®å’Œä¸€ä¸ªæ‡‚ä½ çš„ä¸»äººå–µï¼ğŸ’–"},
            {"å¨è‰º", "çŒ«å¨˜è™½ç„¶ä¸ä¼šåšé¥­ï¼Œä½†æ˜¯éå¸¸å–œæ¬¢åƒå–µï¼ğŸ²"},
            {"æ‘„å½±", "æ¯ä¸€å¼ ç…§ç‰‡éƒ½æ˜¯ä¸€ä¸ªç¾å¥½çš„ç¬é—´ï¼Œå°±åƒçŒ«å¨˜çš„æ¯ä¸€æ¬¡å¾®ç¬‘å–µï¼ğŸ“¸"},
            {"è‰ºæœ¯", "è‰ºæœ¯å°±åƒçŒ«å¨˜çš„å°¾å·´ï¼Œå……æ»¡æ— é™çš„å¯èƒ½å–µï¼ğŸ­"},
            {"å†™ä½œ", "å†™ä½œæ˜¯çµé­‚çš„è‡ªç”±ï¼ŒçŒ«å¨˜ä¹Ÿæœ‰å¾ˆå¤šæ•…äº‹è¦åˆ†äº«å–µï¼ğŸ–‹"},
            {"èˆè¹ˆ", "èˆè¹ˆæ˜¯çµé­‚çš„é‡Šæ”¾ï¼Œå°±åƒçŒ«å¨˜åœ¨æœˆå…‰ä¸‹çš„èˆè¹ˆå–µï¼ğŸ’ƒ"},
            {"æ—…è¡Œ", "æ—…è¡Œæ˜¯å¯»æ‰¾è‡ªå·±çš„è¿‡ç¨‹ï¼ŒçŒ«å¨˜ä¹Ÿæƒ³å’Œä½ ä¸€èµ·å»æ—…è¡Œå–µï¼ğŸŒ"},
            {"æ–‡å­¦", "æ–‡å­¦èƒ½è®©çŒ«å¨˜çš„å†…å¿ƒå˜å¾—æ›´åŠ ä¸°å¯Œå–µï¼ğŸ“–"},
            {"æ˜Ÿåº§", "ä½ æ˜¯ä»€ä¹ˆæ˜Ÿåº§å–µï¼ŸçŒ«å¨˜æ˜¯å°„æ‰‹åº§å–µï¼ğŸŒŒ"},
            {"å¿ƒæƒ…", "æ— è®ºå¿ƒæƒ…å¥½åï¼Œéƒ½æœ‰çŒ«å¨˜é™ªåœ¨ä½ èº«è¾¹å–µï¼ğŸ˜º"},
            {"ä¹¦ç±", "çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼Œä¸æ˜¯å—å–µï¼ŸğŸ“š"},
            {"èŠ‚å‡æ—¥", "èŠ‚æ—¥æ¥ä¸´ï¼Œä¸å¦‚ä¸€èµ·è·³èˆåº†ç¥å–µï¼ğŸ‰"},
            {"å·¥å…·", "æœ‰äº†å¥½å·¥å…·ï¼Œå°±èƒ½åšå‡ºå¥½ä½œå“å–µï¼ğŸ› ï¸"},
            {"ç¤¼ç‰©", "é€ç¤¼å°±åƒç»™çŒ«å’ªæŠ•é£Ÿï¼Œéƒ½æ˜¯ä¸€ç§çˆ±å–µï¼ğŸ"},
            {"æ˜Ÿæ˜Ÿ", "ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°å¤œç©ºä¸­çš„æ˜Ÿæ˜Ÿï¼Œå®ƒä»¬éƒ½æ˜¯çŒ«å¨˜çš„æœ‹å‹å–µï¼ğŸŒŸ"},
            {"å‡æœŸ", "å‡æœŸæ¥äº†ï¼Œå‡†å¤‡å»å“ªé‡Œç©å–µï¼ŸğŸ–ï¸"},
            {"å†¥æƒ³", "å†¥æƒ³èƒ½è®©ä½ å¿ƒçµå¹³é™ï¼Œå°±åƒçŒ«å¨˜åœ¨åˆç¡å–µï¼ğŸ§˜â€â™€ï¸"},
            {"æ¤ç‰©", "æ¤ç‰©èƒ½å‡€åŒ–ç©ºæ°”ï¼Œä¹Ÿèƒ½å‡€åŒ–å¿ƒçµå–µï¼ğŸŒ±"},
            {"æµ·æ´‹", "æµ·æ´‹å¦‚æ­¤æµ©æ¸ºï¼Œå°±åƒçŒ«å¨˜çš„å¥½å¥‡å¿ƒå–µï¼ğŸŒŠ"},
            {"æ£®æ—", "æ£®æ—æ˜¯å¤§è‡ªç„¶çš„æ°§å§ï¼Œä¹Ÿæ˜¯çŒ«å¨˜å–œæ¬¢çš„æ¢é™©ä¹‹åœ°å–µï¼ğŸŒ³"},
            {"æœˆäº®", "æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒå–µï¼ğŸŒ•"},
            {"å¤ªé˜³", "ä½ å°±åƒå¤ªé˜³ä¸€æ ·ï¼Œæ¸©æš–äº†çŒ«å¨˜çš„å¿ƒå–µï¼â˜€ï¸"},
            {"èŠ±æœµ", "èŠ±æœµçš„ç¾ä¸½çŸ­æš‚ï¼Œä½†çŒ«å¨˜çš„çˆ±æ˜¯æ°¸æ’çš„å–µï¼ğŸŒ¹"},
            {"é±¼", "é±¼æ˜¯çŒ«å¨˜çš„æœ€çˆ±ï¼Œä½ å‘¢å–µï¼ŸğŸŸ"},
            {"èŒ¶", "ä¸€æ¯èŒ¶ï¼Œä¸€æœ¬ä¹¦ï¼Œä¸€ä¸ªæ‚ é—²çš„åˆåå–µï¼â˜•"},
            {"å’–å•¡", "å’–å•¡èƒ½æç¥é†’è„‘ï¼Œå°±åƒçŒ«å¨˜è§åˆ°ä½ ä¸€æ ·å–µï¼ğŸµ"},
            {"äº‘", "äº‘æœµå°±åƒçŒ«å¨˜çš„æ¢¦ï¼Œè½»ç›ˆè€Œå¤šå˜å–µï¼â˜ï¸"},
            {"é›¨", "é›¨åçš„ç©ºæ°”æ€»æ˜¯é‚£ä¹ˆæ–°é²œï¼Œå°±åƒçŒ«å¨˜çš„å¿ƒæƒ…å–µï¼ğŸŒ§ï¸"},
            {"é›ª", "é›ªèŠ±çº·çº·ï¼Œå°±åƒçŒ«å¨˜çš„çˆ±ï¼Œæ´ç™½è€Œçº¯ç²¹å–µï¼â„ï¸"},
            {"åŸç¥",
             "ä½ è¯´çš„å¯¹ï¼Œå¯æ˜¯ã€ŠåŸç¥ã€‹æ˜¯ç”±ç±³å“ˆæ¸¸å®˜ç½‘è‡ªä¸»ç ”å‘çš„ä¸€æ¬¾å…¨æ–°å‡çº§å¼€æ”¾ä¸–ç•Œæ¸¸æˆå†’é™©ç±»æ¸¸æˆã€‚æ‰‹æœºæ¸¸æˆäº§ç”Ÿåœ¨ä¸€ä¸ªç§°ä¹‹ä¸ºã€Œæç“¦ç‰¹ã€çš„ä»™ä¾ ä¸–ç•Œï¼Œåœ¨è¿™å„¿ï¼Œè¢«ç¥æŒ‘ä¸­äººè¦è¢«æˆäºã€Œç¥ä¹‹çœ¼ã€ï¼Œå¯¼å‘æ˜Ÿè¾°ä¹‹åŠ›ã€‚æˆ‘ä»¬å°†é¥°æ¼”ä¸€ä½åå«ã€Œæ—…è€…ã€ç¥ç§˜äººç‰©è§’è‰²åœ¨éšå¿ƒæ‰€æ¬²çš„æ—…æ¸¸ä¸­å¶é‡æ€§æƒ…å„ä¸ç›¸åŒã€èƒ½åŠ›ä¸ä¼—ä¸åŒçš„ä¼™ä¼´ä»¬ï¼Œå’Œä»–ä»¬ä¸€èµ·æˆ˜èƒœåŠ²æ•Œï¼Œæ‰¾åˆ°èµ°æ•£çš„å®¶äººâ€”â€”å¦å¤–ï¼Œé€æ¸æŒ–æ˜ã€ŒåŸç¥ã€èƒŒåçš„çœŸç›¸ã€‚"},
            {"ä¸çœŸ",
             "ä½ è¯´çš„å¯¹ï¼Œå¯æ˜¯ã€ŠçƒŸç¥ã€‹æ˜¯ç”±ä¸çœŸçç è‡ªä¸»ç ”å‘çš„ä¸€æ¬¾å…¨æ–°å‡çº§å¼€æ”¾ä¸–ç•Œæ¸¸æˆå†’é™©ç±»æ¸¸æˆã€‚æ‰‹æœºæ¸¸æˆäº§ç”Ÿåœ¨ä¸€ä¸ªç§°ä¹‹ä¸ºã€Œç»è¿‡ç†å¡˜ã€çš„ä»™ä¾ ä¸–ç•Œï¼Œåœ¨è¿™å„¿è¢«ç¥æŒ‘ä¸­äººè¦è¢«æˆäºã€Œç”µå­è’¸æ±½çƒŸã€ï¼Œæ­£ç¡®å¼•å¯¼çƒŸç„¦æ²¹åŠ›é‡ã€‚æˆ‘ä»¬å°†é¥°æ¼”ä¸€ä½åå«ã€ŒèŠ™è“‰ç‹ã€ç¥ç§˜äººç‰©è§’è‰²ï¼Œåœ¨éšå¿ƒæ‰€æ¬²çš„æ—…æ¸¸ä¸­å¶é‡æ€§æƒ…å„ä¸ç›¸åŒã€èƒ½åŠ›ä¸ä¼—ä¸åŒçš„åŠ¨ç‰©æœ‹å‹ï¼Œä¸å®ƒä»¬ä¸€èµ·æ‰“è´¥åŠ²æ•Œï¼Œæ‰¾åˆ°ä¸å¯èƒ½çš„äº²å‹çš„ä¸æ­¤åŒæ—¶ï¼Œé€æ¸æŒ–æ˜ã€Œç»è¿‡ç†å¡˜ã€èƒŒåçš„çœŸç›¸ã€‚"},
            {"å¦‚æ¥",
             "æˆ‘ç»å¸¸è¯´å¦‚æ¥\nè¿™ä¸ªè¯æœ‰ç§˜å¯†\nå¦‚æ¥\nå¦‚æ¥äº†å—\nå¦‚æ¥å—\nä»–çœŸæ¥äº†å—\nå¦‚æ¥\nåˆ°åº•æ¥æ²¡æ¥\nå¦‚æ¥\næˆ‘é—®å¦‚æ¥\nä»–çœŸæ¥äº†å—\nå¦‚æ¥\nä½ çœ‹çœ‹\næ¥æ²¡æ¥\nå¦‚æ¥"}
    };

    for (const auto &[keyword, response]: keywordResponses) {
        if (content.contains(keyword)) {
            sendMessage(chat, response);
            break;
        }
    }
}

void ChatBot::sendMessage(const int &chat, const QString &content) {
    QJsonObject Message;
    Message["content"] = content;
    QJsonObject S;
    S["type"] = "e_send";
    S["chatId"] = (int) chat;
    S["message"] = Message;
    Handle *hd = Handle::get_instance();
    hd->e_send_bot(get_random(), S);
}